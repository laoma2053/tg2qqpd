version: "3.9"

# =========================
# æ‰€æœ‰æœåŠ¡å…±ç”¨ä¸€ä¸ªå†…éƒ¨ç½‘ç»œ
# ä¸å¯¹å¤–æš´éœ² redis / postgres
# =========================
networks:
  tg2qq-net:
    driver: bridge

# =========================
# æŒä¹…åŒ–æ•°æ®å·
# =========================
volumes:
  pg_data:        # PostgreSQL æ•°æ®
  tg_session:     # Telegram sessionï¼ˆéå¸¸é‡è¦ï¼‰
  tg_media:       # TG ä¸‹è½½çš„åª’ä½“æ–‡ä»¶ï¼ˆbackend ä¸ worker å…±äº«ï¼‰

services:

  # =========================
  # PostgreSQLï¼šåªåšå­˜å‚¨
  # =========================
  postgres:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: tg2qq
      POSTGRES_USER: tg2qq
      POSTGRES_PASSWORD: tg2qqpass
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - tg2qq-net
    # â—â—â— ä¸è¦åŠ  ports
    # æ•°æ®åº“æ°¸è¿œä¸åº”è¯¥æš´éœ²åˆ°å…¬ç½‘

  # =========================
  # Redisï¼šé˜Ÿåˆ— & è§£è€¦
  # =========================
  redis:
    image: redis:7
    restart: always
    networks:
      - tg2qq-net
    # â— åŒæ ·ä¸è¦æš´éœ²ç«¯å£
    # Redis ä¸€æ—¦æš´éœ² = é«˜é£é™©

  # =========================
  # backendï¼šTG ç›‘å¬ + Web API
  # =========================
  backend:
    build: ./backend
    restart: always
    env_file:
      - .env
    volumes:
      # ğŸ”‘ Telegram ç™»å½•æ€ï¼ˆä¸æŒ‚è½½=æ¯æ¬¡é‡ç™»ï¼‰
      - tg_session:/app
      # ğŸ”¥ é…ç½®çƒ­æ›´æ–°çš„å…³é”®
      - ./mapping.json:/app/mapping.json
      - ./blacklist.json:/app/blacklist.json
      # ğŸ–¼ï¸ TG åª’ä½“æ–‡ä»¶å…±äº«ï¼ˆä¾› worker è¯»å–ï¼‰
      - tg_media:/tmp
    depends_on:
      - postgres
      - redis
    networks:
      - tg2qq-net
    ports:
      # åªæš´éœ²åå°ç®¡ç†æ¥å£
      # å¦‚æœä½ ä¸éœ€è¦åå°ï¼Œå¯ç›´æ¥åˆ æ‰
      - "8000:8000"

  # =========================
  # workerï¼šçœŸæ­£å‘ QQ æ¶ˆæ¯
  # =========================
  worker:
    build: ./backend
    command: python worker.py
    restart: always
    env_file:
      - .env
    volumes:
      - ./mapping.json:/app/mapping.json
      - ./blacklist.json:/app/blacklist.json
      # ğŸ–¼ï¸ ä¸ backend å…±äº« /tmpï¼ˆè¯»å–ä¸‹è½½çš„å›¾ç‰‡å¹¶å‹ç¼©/ä¸Šä¼ ï¼‰
      - tg_media:/tmp
    depends_on:
      - redis
      - postgres
    networks:
      - tg2qq-net
    # â—â—â— ä¸è¦ ports
    # worker æ°¸è¿œä¸åº”è¯¥è¢«å¤–éƒ¨è®¿é—®
